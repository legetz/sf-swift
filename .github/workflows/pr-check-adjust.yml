name: PR check/adjust

on:
  workflow_dispatch:
  # Uncomment the following to trigger on PRs
  # pull_request:
  #  types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '24'
  # Configure which metadata types to include (comma-separated, no spaces)
  INCLUDED_TYPES: ''
  # Process only files changed in the PR by default
  ADJUST_DELTA_ONLY: 'true'

jobs:
  check-rej-files:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install SF Swift plugin
        run: |
          npm install -g @salesforce/cli
          echo "y" | sf plugins install sf-swift
      
      - name: Configure GIT
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Detect GIT conflicts
        id: detect
        continue-on-error: true
        run: |
          OUTPUT=$(sf swift detect git conflicts --json || true)
          echo "$OUTPUT" | tee detect-output.json

          STATUS=$(jq -r 'if (.status | type == "number") then .status else 1 end' detect-output.json)
          REJ_COUNT=$(jq -r '.result.count // 0' detect-output.json)
          CONFLICT_FILES=$(jq -r '(.result.conflictFiles // []) | join("\n")' detect-output.json)

          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "rej_count=${REJ_COUNT}" >> $GITHUB_OUTPUT
          printf 'conflict_files<<EOF\n%s\nEOF\n' "$CONFLICT_FILES" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: ${{ steps.detect.outputs.rej_count != '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const rejCount = Number('${{ steps.detect.outputs.rej_count }}');
            const conflictFiles = `${{ steps.detect.outputs.conflict_files }}`.trim();
            const conflictList = conflictFiles ? `**Conflict files:**\n\n\`\`\`\n${conflictFiles}\n\`\`\`` : '';

            const bodySections = [
              '‚ö†Ô∏è **GIT reject files detected**',
              `Pull-request contains ${rejCount} .rej file${rejCount === 1 ? '' : 's'}.`,
              'Please resolve the merge conflicts and remove the generated `.rej` files.',
              conflictList,
              '‚ö° Powered by [sf-swift plugin](https://www.npmjs.com/package/sf-swift)'
            ].filter(Boolean);

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: bodySections.join('\n\n')
            });

      - name: Fail when reject files detected
        if: ${{ steps.detect.outputs.rej_count != '0' }}
        run: exit 1

  check-integrity:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install SF Swift plugin
        run: |
          npm install -g @salesforce/cli
          echo "y" | sf plugins install sf-swift

      - name: Calculate PR commit count
        id: calc-depth
        run: |
          PR_COMMITS=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)
          echo "git_depth=${PR_COMMITS}" >> $GITHUB_OUTPUT
          echo "üìä PR has ${PR_COMMITS} commits"

      - name: Run metadata integrity check
        id: integrity
        continue-on-error: true
        run: |
          GIT_DEPTH=${{ steps.calc-depth.outputs.git_depth }}

          set +e
          OUTPUT=$(sf swift metadata integrity --target-dir test-files/original --git-depth ${GIT_DEPTH:-5} --json)
          COMMAND_STATUS=$?
          set -e

          echo "$OUTPUT" | tee integrity-output.json

          STATUS=0
          ISSUE_COUNT=0
          ISSUE_DETAILS=""

          if [ -s integrity-output.json ]; then
            if jq -e '.status' integrity-output.json >/dev/null 2>&1; then
              STATUS=$(jq -r 'if (.status | type == "number") then .status else 1 end' integrity-output.json)
              ISSUE_COUNT=$(jq -r '.data.issues | length // 0' integrity-output.json)
              ISSUE_DETAILS=$(jq -r '.data.issues[]? | "- " + (.detail // "Unknown issue") + " ‚Üí " + (.referencingFile // "Unknown file")' integrity-output.json)
            else
              STATUS=${COMMAND_STATUS:-1}
              ISSUE_DETAILS="Failed to parse metadata integrity output."
            fi
          else
            STATUS=${COMMAND_STATUS:-1}
            ISSUE_DETAILS="Metadata integrity command produced no output."
          fi

          echo "status=${STATUS}" >> $GITHUB_OUTPUT
          echo "issue_count=${ISSUE_COUNT}" >> $GITHUB_OUTPUT
          printf 'issue_details<<EOF\n%s\nEOF\n' "$ISSUE_DETAILS" >> $GITHUB_OUTPUT

      - name: Comment on PR
        if: ${{ steps.integrity.outputs.issue_count != '0' }}
        uses: actions/github-script@v7
        with:
          script: |
            const issueCount = Number('${{ steps.integrity.outputs.issue_count }}');
            const gitDepth = '${{ steps.calc-depth.outputs.git_depth }}';
            const details = `${{ steps.integrity.outputs.issue_details }}`.trim();
            const issuesSection = details ? `**Issues:**\n\n${details}` : '';
            const bodySections = [
              '‚ö†Ô∏è **Metadata integrity issues detected**',
              `Scan inspected last ${gitDepth || 'N/A'} commit(s) within pull-request and found ${issueCount} metadata integrity issue${issueCount === 1 ? '' : 's'}.`,
              issuesSection,
              '‚ö° Powered by [sf-swift plugin](https://www.npmjs.com/package/sf-swift)'
            ].filter(Boolean);

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: bodySections.join('\n\n')
            });

      - name: Fail when integrity issues detected
        if: ${{ steps.integrity.outputs.issue_count != '0' }}
        run: exit 1

      - name: Fail when integrity command fails
        if: ${{ steps.integrity.outputs.status != '0' && steps.integrity.outputs.issue_count == '0' }}
        run: |
          echo "Metadata integrity command failed. See previous logs for details." >&2
          exit 1

  adjust-code:
    needs: [check-rej-files, check-integrity]
    runs-on: ubuntu-latest
    if: ${{ needs.check-rej-files.result == 'success' && needs.check-integrity.result == 'success' }}

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Calculate PR commit count
        id: pr-commits
        run: |
          PR_COMMITS=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)
          echo "amount=${PR_COMMITS}" >> $GITHUB_OUTPUT
          echo "üìä PR has ${PR_COMMITS} commits"
      
      - name: Run Prettier
        id: format
        run: |
          ./prettier-fix-delta.sh ${{ steps.pr-commits.outputs.amount }}
          
          if git diff --quiet; then
            echo "modified=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
          else
            echo "modified=true" >> $GITHUB_OUTPUT
            FILE_COUNT=$(git diff --name-only | wc -l | xargs)
            echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
            echo "üìù Modified ${FILE_COUNT} file(s)"
          fi
      
      - name: Commit changes
        if: steps.format.outputs.modified == 'true'
        run: |
          git add **/*.cls **/*.trigger
          git commit -m "ü§ñ Adjusted ${{ steps.format.outputs.file_count }} code files to match Prettier rules"
          for attempt in 1 2 3; do
            echo "üöÄ Push attempt ${attempt}"
            if git pull --rebase origin "${{ github.head_ref }}"; then
              if git push origin HEAD:"${{ github.head_ref }}"; then
                echo "‚úÖ Push succeeded"
                break
              fi
            fi

            if [ ${attempt} -eq 3 ]; then
              echo "‚ùå Failed to push changes after ${attempt} attempts"
              exit 1
            fi

            delay=$((attempt * 5))
            echo "üîÅ Retrying in ${delay}s..."
            sleep ${delay}
          done
      
      - name: Comment on PR
        if: steps.format.outputs.modified == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fileCount = '${{ steps.format.outputs.file_count }}';
            const scope = `Changed files only (${context.payload.pull_request.commits} commits)`;
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **Adjusted ' + fileCount + ' code files to match Prettier rules**\n\n' +
                    'Apex classes/triggers have been adjusted for consistency.\n\n' +
                    '**Scope:** `' + scope + '`\n' +
                    'Please review the changes in the latest commit.'
            });

  adjust-metadata:
    needs: adjust-code
    runs-on: ubuntu-latest
    if: ${{ needs.adjust-code.result == 'success' }}

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install SF Swift plugin
        run: |
          npm install -g @salesforce/cli
          echo "y" | sf plugins install sf-swift
      
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      - name: Calculate PR commit count
        id: calc-depth
        run: |
          PR_COMMITS=$(git rev-list --count origin/${{ github.base_ref }}..HEAD)
          echo "pr_commits=${PR_COMMITS}" >> $GITHUB_OUTPUT
          echo "üìä PR has ${PR_COMMITS} commits"
          if [ "${{ env.ADJUST_DELTA_ONLY }}" = "true" ]; then
            echo "use_git_depth=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Will process only files changed (delta mode)"
          else
            echo "use_git_depth=false" >> $GITHUB_OUTPUT
            echo "üìÅ Will process all files (full mode)"
          fi
      
      - name: Run metadata adjust
        id: format
        run: |
          echo "Configure parameters:"
          CMD="sf swift metadata adjust"
          if [ "${{ steps.calc-depth.outputs.use_git_depth }}" = "true" ]; then
            CMD="${CMD} --git-depth ${{ steps.calc-depth.outputs.pr_commits }}"
            echo "üéØ Processing only changed files (last ${{ steps.calc-depth.outputs.pr_commits }} commits)"
          fi
          if [ -n "${{ env.INCLUDED_TYPES }}" ]; then
            CMD="${CMD} --include ${{ env.INCLUDED_TYPES }}"
            echo "üìã Including types: ${{ env.INCLUDED_TYPES }}"
          else
            echo "üìã Processing all whitelisted metadata types"
          fi
          echo "Running: ${CMD}"
          eval ${CMD}
          if git diff --quiet; then
            echo "modified=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
          else
            echo "modified=true" >> $GITHUB_OUTPUT
            FILE_COUNT=$(git diff --name-only | wc -l | xargs)
            echo "file_count=${FILE_COUNT}" >> $GITHUB_OUTPUT
            echo "üìù Modified ${FILE_COUNT} file(s)"
          fi
      
      - name: Commit changes
        if: steps.format.outputs.modified == 'true'
        run: |
          git add **/*-meta.xml
          git commit -m "ü§ñ Adjusted ${{ steps.format.outputs.file_count }} metadata files

          ‚ö° Powered by [sf-swift plugin](https://www.npmjs.com/package/sf-swift)"
          for attempt in 1 2 3; do
            echo "üöÄ Push attempt ${attempt}"
            if git pull --rebase origin "${{ github.head_ref }}"; then
              if git push origin HEAD:"${{ github.head_ref }}"; then
                echo "‚úÖ Push succeeded"
                break
              fi
            fi

            if [ ${attempt} -eq 3 ]; then
              echo "‚ùå Failed to push changes after ${attempt} attempts"
              exit 1
            fi

            delay=$((attempt * 5))
            echo "üîÅ Retrying in ${delay}s..."
            sleep ${delay}
          done
      
      - name: Comment on PR
        if: steps.format.outputs.modified == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const deltaMode = '${{ env.ADJUST_DELTA_ONLY }}' === 'true';
            const fileCount = '${{ steps.format.outputs.file_count }}';
            const scope = deltaMode 
              ? `Changed files only (${context.payload.pull_request.commits} commits)` 
              : 'All files in directory';
            const typesProcessed = process.env.INCLUDED_TYPES || 'All whitelisted types';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ **Adjusted ' + fileCount + ' metadata files**\n\n' +
                    'Metadata files have been adjusted for consistency.\n\n' +
                    '**Scope:** `' + scope + '`\n' +
                    '**Types processed:** `' + typesProcessed + '`\n\n' +
                    'Please review the changes in the latest commit.\n\n' +
                    '‚ö° Powered by [sf-swift plugin](https://www.npmjs.com/package/sf-swift)'
            });
